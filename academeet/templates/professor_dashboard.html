{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Dashboard - Academeet</title>
    <link rel="stylesheet" href="{% static 'core/css/professor_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/holidays.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/calendar.css' %}">
</head>
<body>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>

    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </div>
                <h1>Academeet</h1>
            </div>
            <div class="user-section">
                <div class="profile-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                </div>
                <span class="user-name">{{ user.username }}</span>
                <div class="status-dropdown-wrapper">
                    <button class="status-toggle" id="statusToggle" title="Change status">
                        <span class="status-circle" id="statusCircle" data-status="{{ professor_status }}"></span>
                    </button>
                    <div class="status-dropdown" id="statusDropdown">
                        <button class="status-option" data-status="available" title="Available">
                            <span class="status-circle" style="background-color: #4CAF50;"></span>
                            <span class="status-label">Available</span>
                        </button>
                        <button class="status-option" data-status="busy" title="Busy">
                            <span class="status-circle" style="background-color: #FF9800;"></span>
                            <span class="status-label">Busy</span>
                        </button>
                        <button class="status-option" data-status="absent" title="Absent">
                            <span class="status-circle" style="background-color: #F44336;"></span>
                            <span class="status-label">Absent</span>
                        </button>
                    </div>
                </div>
                <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div class="dashboard-title">
            <h2>Professor Dashboard</h2>
            <p class="subtitle">Manage your weekly schedule</p>
        </div>

        <!-- Main Content Area -->
        <div class="content-grid">
            <div class="left-column">
                <div class="schedule-header">
                    <a href="{% url 'add_schedule' %}" class="btn btn-primary add-schedule-btn">Add Schedule</a>
                </div>

                <!-- Schedule Table -->
                <div class="schedule-wrapper">
                    <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="time-column">Time</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                            <th>Saturday</th>
                            <th>Sunday</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in grid_rows %}
                        <tr{% if row.half_hour %} class="half-hour"{% endif %}>
                            <td class="time-cell{% if row.bold_time %} bold-time{% endif %}">{{ row.label }}</td>

                            {% for cell in row.cells %}
                                {% if cell == 'SPAN' %}
                                    {% comment %}This column is covered by a previous rowspan{% endcomment %}
                                {% elif cell %}
                                    <td class="schedule-cell
                                        {% if cell.status == 'In Class' %}class-green
                                        {% elif cell.status == 'Out of Work' %}class-red
                                        {% elif cell.status == 'Available' %}class-blue
                                        {% endif %}" rowspan="{{ cell.rowspan }}">
                                        <div class="schedule-info">
                                            <div class="schedule-content">
                                                <strong>{{ cell.subject_code }}</strong><br>
                                                <small>{{ cell.section }}</small><br>
                                                <small>{{ cell.room }}</small>
                                            </div>
                                            <div class="schedule-actions">
                                                <a href="{% url 'edit_schedule' cell.id %}" class="edit-btn" title="Edit">
                                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                </a>
                                                <form method="POST" action="{% url 'delete_schedule' cell.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this schedule?')">
                                                    {% csrf_token %}
                                                    <button type="submit" class="delete-btn" title="Delete">
                                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                {% else %}
                                    <td class="schedule-cell"></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>

            <div class="calendar-container">
  <div class="calendar-header">
    <button id="prevMonth">◀</button>
    <span id="monthYear">October 2025</span>
    <button id="nextMonth">▶</button>
  </div>

  <table class="calendar-table">
    <thead>
      <tr>
        <th>Sun</th>
        <th>Mon</th>
        <th>Tue</th>
        <th>Wed</th>
        <th>Thu</th>
        <th>Fri</th>
        <th>Sat</th>
      </tr>
    </thead>
    <tbody id="calendarBody">
      <!-- JS will insert the dates here -->
    </tbody>
  </table>

  <div id="holidayTooltip" class="holiday-tooltip"></div>

  <!-- Holiday Details Section -->
    <div class="holiday-details-section">
        <ul id="holidayDetailsList">
            <li style="color: #999;">Loading holidays...</li>
        </ul>
    </div>
</div>


<!-- Calendar JS -->
<script src="{% static 'core/js/calendar.js' %}"></script>

<!-- Status Dropdown JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusToggle = document.getElementById('statusToggle');
    const statusDropdown = document.getElementById('statusDropdown');
    const statusCircle = document.getElementById('statusCircle');
    const statusOptions = document.querySelectorAll('.status-option');

    // Color mapping
    const statusColors = {
        'available': '#4CAF50',
        'busy': '#FF9800',
        'absent': '#F44336'
    };

    // Load initial status from server
    fetch('{% url "api_get_professor_status" %}')
        .then(response => response.json())
        .then(data => {
            const status = data.status || 'available';
            updateStatusDisplay(status);
        })
        .catch(error => console.error('Error loading status:', error));

    // Toggle dropdown visibility
    statusToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        statusDropdown.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.status-dropdown-wrapper')) {
            statusDropdown.classList.remove('active');
        }
    });

    // Handle status option selection
    statusOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const status = this.getAttribute('data-status');
            
            // Send to server
            fetch('{% url "api_set_professor_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                   getCookie('csrftoken')
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatusDisplay(status);
                    statusDropdown.classList.remove('active');
                } else {
                    console.error('Error saving status:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    function updateStatusDisplay(status) {
        statusCircle.style.backgroundColor = statusColors[status];
        statusCircle.setAttribute('data-status', status);
    }

    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

    </main>
</body>
</html>
